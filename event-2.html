<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>THE GRAND CELEBRATION | VIP Invite</title>

  <script src="https://cdn.tailwindcss.com"></script>

  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;800&family=Cormorant+Garamond:ital,wght@0,400;0,600;1,400&family=Montserrat:wght@200;400;500&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            'luxury': ['Cinzel', 'serif'],
            'elegant': ['Cormorant Garamond', 'serif'],
            'modern': ['Montserrat', 'sans-serif'],
          }
        }
      }
    }
  </script>

  <style>
    :root{
      --bg: #050505;
      --panel: rgba(255,255,255,.05);
      --panel2: rgba(0,0,0,.35);
      --line: rgba(255,255,255,.10);
      --muted: rgba(255,255,255,.55);
      --text: rgba(255,255,255,.92);
      --accent: #D4AF37;  /* gold */
      --accent2: #8A7036; /* gold-dim */
      --shadow: 0 30px 80px rgba(0,0,0,.55);
      --radius: 18px;
    }

    body { background-color: var(--bg); color: var(--text); overflow-x: hidden; }

    .accent-text{ color: var(--accent); }
    .accent-dim{ color: var(--accent2); }
    .accent-border{ border-color: color-mix(in srgb, var(--accent) 35%, transparent); }
    .panel{ background: var(--panel); }
    .panel-strong{ background: var(--panel2); }
    .soft-line{ border-color: var(--line); }

    .text-gold-shine {
      background: linear-gradient(to right, #BF953F, #FCF6BA, #B38728, #FBF5B7, #AA771C);
      -webkit-background-clip: text; background-clip: text; color: transparent;
      background-size: 200% auto; animation: shine 6s linear infinite;
    }
    @keyframes shine { to { background-position: 200% center; } }

    .hide-scrollbar::-webkit-scrollbar { display: none; }
    .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

    #entrance-screen {
      position: fixed; inset: 0; z-index: 110; background: #000;
      display: flex; align-items: center; justify-content: center;
      transition: transform 1.2s cubic-bezier(0.77, 0, 0.175, 1);
      will-change: transform;
    }
    .envelope-hidden { transform: translateY(-100%); }

    #pin-screen{
      position: fixed; inset: 0; z-index: 120;
      display: none; align-items: center; justify-content: center;
      background: radial-gradient(900px 420px at 50% 10%, rgba(212,175,55,.10), rgba(0,0,0,.92));
    }
    #pin-screen.active{ display:flex; }

    .reveal { opacity: 0; transform: translateY(30px); transition: all 1s ease-out; }
    .reveal.active { opacity: 1; transform: translateY(0); }

    .video-overlay {
      position:absolute; inset:0;
      background: radial-gradient(900px 420px at 50% 10%, rgba(212,175,55,.10), rgba(0,0,0,.55));
      pointer-events:none;
    }

    .texture {
      position: fixed; inset:0; pointer-events:none; opacity:.18;
      background-image: url('https://www.transparenttextures.com/patterns/stardust.png');
    }

    @keyframes shake {
      0%,100%{ transform: translateX(0); }
      20%{ transform: translateX(-6px); }
      40%{ transform: translateX(6px); }
      60%{ transform: translateX(-4px); }
      80%{ transform: translateX(4px); }
    }
    .shake{ animation: shake .35s ease-in-out; }

    #adminModal{
      position: fixed; inset:0; z-index: 200;
      display:none; align-items:center; justify-content:center;
      background: rgba(0,0,0,.72);
      padding: 18px;
    }
    #adminModal.open{ display:flex; }
  </style>
</head>

<body class="font-modern">

  <div id="pin-screen" aria-modal="true" role="dialog">
    <div class="w-full max-w-md mx-auto px-6">
      <div class="panel border soft-line rounded-2xl p-8 shadow-[0_30px_80px_rgba(0,0,0,.55)]">
        <div class="text-center">
          <div class="w-20 h-20 mx-auto mb-5 rounded-full border soft-line flex items-center justify-center relative">
            <div class="absolute inset-0 rounded-full" style="background: rgba(212,175,55,.10);"></div>
            <span class="font-luxury text-4xl accent-text" id="pinMonogram">S</span>
          </div>
          <h2 class="font-luxury text-white text-xl tracking-[0.35em] mb-2">VIP ACCESS</h2>
          <p class="text-xs" style="color: var(--muted); letter-spacing:.14em; text-transform:uppercase;">
            Enter your private code
          </p>
        </div>

        <div class="mt-8" id="pinBox">
          <label class="text-xs uppercase tracking-widest" style="color: var(--muted);">Access Code</label>
          <input id="pinInput" inputmode="numeric" maxlength="10"
                 class="mt-2 w-full bg-black/30 border-b border-white/20 py-3 text-white focus:outline-none focus:border-[color:var(--accent)] transition placeholder-gray-600"
                 placeholder="••••" />
          <div class="mt-3 flex items-center justify-between gap-3">
            <label class="text-xs" style="color: var(--muted);">
              <input type="checkbox" id="rememberDevice" class="mr-2 align-middle" />
              Remember this device
            </label>
            <button id="pinSubmit"
              class="px-5 py-2 rounded-full border soft-line text-xs hover:border-[color:var(--accent)] transition"
              style="background: rgba(0,0,0,.35);">
              Unlock
            </button>
          </div>
          <p id="pinError" class="text-xs mt-3 hidden" style="color: rgba(255,255,255,.75);">
            Incorrect code. Please try again.
          </p>
        </div>

        <div class="mt-8 border-t soft-line pt-5">
          <p class="text-[11px]" style="color: var(--muted); line-height:1.6;">
            This invitation is delivered as a private shareable link. No downloads required.
          </p>
        </div>
      </div>
    </div>
  </div>

  <div id="entrance-screen">
    <div class="text-center relative px-6">
      <div class="w-24 h-24 mx-auto mb-8 rounded-full border-2 soft-line flex items-center justify-center relative">
        <div class="absolute inset-0 rounded-full" style="background: rgba(212,175,55,.10);"></div>
        <span class="font-luxury text-4xl accent-text" id="monogram">S</span>
      </div>
      <h2 class="font-luxury text-white text-xl tracking-[0.4em] mb-2" id="privateLabel">PRIVATE EVENT</h2>
      <p class="text-gray-500 text-xs mb-10 tracking-widest uppercase" id="clickLabel">Click to Reveal Invitation</p>

      <button id="open-btn"
        class="group relative px-8 py-4 bg-transparent border accent-border text-[color:var(--accent)] font-luxury tracking-widest hover:bg-[color:var(--accent)] hover:text-black transition duration-500">
        OPEN ENVELOPE
      </button>

      <div class="mt-10 flex flex-wrap justify-center gap-2">
        <button class="themeBtn px-4 py-2 rounded-full text-[11px] border soft-line hover:border-[color:var(--accent)] transition" data-theme="vip">
          Dark VIP
        </button>
        <button class="themeBtn px-4 py-2 rounded-full text-[11px] border soft-line hover:border-[color:var(--accent)] transition" data-theme="ivory">
          Minimal Ivory
        </button>
        <button class="themeBtn px-4 py-2 rounded-full text-[11px] border soft-line hover:border-[color:var(--accent)] transition" data-theme="floral">
          Soft Floral
        </button>
        <button class="themeBtn px-4 py-2 rounded-full text-[11px] border soft-line hover:border-[color:var(--accent)] transition" data-theme="boho">
          Boho Earth
        </button>
      </div>
      <p class="mt-3 text-[11px]" style="color: var(--muted);">Theme is adjustable per client before delivery.</p>
    </div>
  </div>

  <div class="texture"></div>

  <div id="main-content" class="relative min-h-screen">

    <audio id="bgMusic" loop preload="metadata">
      <source src="assets/music.mp3" type="audio/mpeg">
    </audio>

    <button id="music-btn"
      class="fixed bottom-6 right-6 z-50 w-12 h-12 panel-strong backdrop-blur border accent-border rounded-full accent-text flex items-center justify-center shadow-[0_0_15px_rgba(212,175,55,0.25)] hover:scale-110 transition"
      aria-label="Music" aria-pressed="false" title="Music">
      <i class="fa-solid fa-music"></i>
    </button>

    <div class="fixed bottom-6 left-6 z-50 hidden md:flex flex-col gap-3">
      <button id="share-btn" class="px-4 py-3 panel-strong border soft-line rounded-full text-xs text-white/80 hover:text-white hover:border-[color:var(--accent)] transition backdrop-blur">
        <i class="fa-solid fa-link mr-2"></i> Share Link
      </button>
      <a href="#rsvp" class="px-4 py-3 panel-strong border soft-line rounded-full text-xs text-white/80 hover:text-white hover:border-[color:var(--accent)] transition backdrop-blur">
        <i class="fa-solid fa-pen-to-square mr-2"></i> RSVP
      </a>
      <a href="#map" class="px-4 py-3 panel-strong border soft-line rounded-full text-xs text-white/80 hover:text-white hover:border-[color:var(--accent)] transition backdrop-blur">
        <i class="fa-solid fa-location-dot mr-2"></i> Directions
      </a>
    </div>

    <div id="a2hs"
      class="fixed top-4 left-1/2 -translate-x-1/2 z-50 hidden md:block px-4 py-3 panel-strong border soft-line rounded-full text-[11px] text-white/70 backdrop-blur">
      Tip: On iPhone, tap <span class="accent-text font-semibold">Share</span> → <span class="accent-text font-semibold">Add to Home Screen</span>
      <button id="a2hsClose" class="ml-3 opacity-70 hover:opacity-100"><i class="fa-solid fa-xmark"></i></button>
    </div>

    <header class="relative pt-24 pb-16 text-center px-4 overflow-hidden">

      <div class="absolute inset-0 -z-10">
        <video id="bgVideo" class="w-full h-full object-cover opacity-20" playsinline muted loop preload="metadata">
          <source src="assets/bg.mp4" type="video/mp4">
        </video>
        <div class="video-overlay"></div>
      </div>

      <p class="tracking-[0.3em] text-xs uppercase mb-6 reveal" style="color: rgba(212,175,55,.8);" id="heroTop">
        Join us for the 30th Birthday of
      </p>

      <h1 class="font-luxury text-6xl md:text-8xl text-gold-shine mb-6 drop-shadow-2xl reveal" id="heroName">
        SOPHIA
      </h1>

      <div class="h-px w-32 mx-auto mb-6 reveal" style="background: linear-gradient(to right, transparent, var(--accent), transparent);"></div>

      <p class="font-elegant text-2xl text-white/80 italic reveal" id="heroQuote">
        "A Night of Elegance & Memories"
      </p>

      <div class="mt-8 reveal">
        <span id="eventStatusBadge"
          class="inline-flex items-center gap-2 px-4 py-2 rounded-full border soft-line panel-strong text-xs text-white/80 backdrop-blur">
          <i class="fa-regular fa-clock"></i>
          <span id="eventStatusText">Counting down</span>
        </span>
      </div>

      <div class="max-w-4xl mx-auto mt-10 px-6 reveal">
        <div class="grid md:grid-cols-3 gap-4">
          <div class="panel border soft-line rounded-xl p-4 text-center">
            <div class="text-xs tracking-widest uppercase text-gray-400 mb-2">QR · RSVP</div>
            <div class="mx-auto w-[120px] h-[120px] panel-strong rounded-lg border soft-line flex items-center justify-center" id="qr-rsvp">
              <span class="text-gray-600 text-xs">Loading…</span>
            </div>
          </div>

          <div class="panel border soft-line rounded-xl p-4 text-center">
            <div class="text-xs tracking-widest uppercase text-gray-400 mb-2">QR · Map</div>
            <div class="mx-auto w-[120px] h-[120px] panel-strong rounded-lg border soft-line flex items-center justify-center" id="qr-map">
              <span class="text-gray-600 text-xs">Loading…</span>
            </div>
          </div>

          <div class="panel border soft-line rounded-xl p-4 text-center">
            <div class="text-xs tracking-widest uppercase text-gray-400 mb-2">QR · Share</div>
            <div class="mx-auto w-[120px] h-[120px] panel-strong rounded-lg border soft-line flex items-center justify-center" id="qr-share">
              <span class="text-gray-600 text-xs">Loading…</span>
            </div>
          </div>
        </div>

        <p class="text-gray-500 text-[11px] mt-4">
          QR codes are generated from this page’s links. In final delivery, they will point to the private shareable link.
        </p>
      </div>
    </header>

    <!-- (Orijinal içerik aynı: moment, countdown, details, guest guide, timeline, gallery, upload, map, RSVP, guestbook, admin modal...) -->
    <!-- Senin gönderdiğin tüm body içeriğini burada değiştirmedim; sadece SCRIPT tarafını aşağıda düzelttim. -->

    <!-- Aşağıdaki bölümler sende zaten var; aynı şekilde bırakabilirsin. -->
    <!-- ... [SENİN BODY BÖLÜMLERİN DEĞİŞMEDEN DEVAM EDİYOR] ... -->

    <!-- Uyarı: Bu yanıtın uzunluğunu makul tutmak için, yukarıda “body içeriğinin” tamamını aynen tekrar etmedim.
         Çünkü senin verdiğin body bölümü zaten doğru; sorunların tamamı <script> içindeydi.
         Aşağıdaki <script> bloğunu senin dosyandaki <script> bloğunun TAMAMIYLA değiştirmen yeterli. -->

    <div style="height:1px"></div>
  </div>

  <!-- =========================================================
       SCRIPT: SENİN DOSYANDAKİ <script> BLOĞUNU KOMPLE BUNUNLA DEĞİŞTİR
       (Body içeriğini aynen bırak)
  ========================================================== -->
  <script>
    /* =========================
       CONFIG (EDIT ONLY THIS)
    ========================== */
    const CONFIG = {
      // Security
      accessPin: "2580",
      adminPin: "9999",

      // ✅ Google Sheets (Apps Script Web App)
      databaseURL: "https://script.google.com/macros/s/AKfycbxt_s1MYqgMPvcV6b2Feak_dLdj2RY8eiSVI5FL7hBp0fbEtekYJyifuRssxRoAZQog/exec",

      // Theme
      theme: "vip",

      // Entrance
      monogram: "S",
      entranceTitle: "PRIVATE EVENT",
      entranceSubtitle: "Click to Reveal Invitation",
      entranceButton: "OPEN ENVELOPE",

      // Hero
      heroTop: "Join us for the 30th Birthday of",
      celebrantName: "SOPHIA",
      heroQuote: "\"A Night of Elegance & Memories\"",

      // Event datetime
      eventStartISO: "2026-10-25T19:00:00-04:00",
      eventEndISO:   "2026-10-26T01:00:00-04:00",

      whenDateText: "Saturday, October 25th, 2026",
      whenTimeText: "19:00 - Late",

      // Venue
      venueName: "The Grand Ballroom",
      venueAddress: "123 Luxury Ave, Manhattan, NY",
      venueQuery: "The Grand Ballroom, 123 Luxury Ave, Manhattan, NY",

      // Dress code / registry
      dressCode: "Black Tie / Formal",
      paletteNote: "Please stick to the palette.",
      registryNote: "Your presence is the greatest gift.",
      registryUrl: "#",

      // Guest guide
      parkingInfo: "Valet parking is available at the entrance. Please arrive 10–15 minutes early for a smooth entry.",
      contactInfo: "For any questions: <span class='text-white'>+1 (000) 000-0000</span> (Host).",
      policyInfo: "Kindly RSVP by the deadline. Venue is adults-only unless stated otherwise. Please respect the dress code.",

      // RSVP (action artık önemsiz; POST Sheets’e gidiyor)
      rsvpDeadlineText: "By October 10th",
      rsvpEndpoint: "https://formspree.io/f/XXXXXXXX",
      successText: "See you on the dance floor.",

      // Guestbook (istersen ayrıca Sheets’e bağlarız)
      guestbookEndpoint: "https://formspree.io/f/XXXXXXXX",

      // Media (LOCAL)
      enableBgVideo: true,
      bgVideoSrc: "assets/bg.mp4",
      momentVideoSrc: "assets/moment.mp4",
      musicSrc: "assets/music.mp3",

      galleryImages: [
        "assets/gallery/1.jpg",
        "assets/gallery/2.jpg",
        "assets/gallery/3.jpg",
        "assets/gallery/4.jpg",
      ],

      photoUploadUrl: "https://drive.google.com/",
      mapEmbedUrl: "https://www.google.com/maps?q=" + encodeURIComponent("The Grand Ballroom, 123 Luxury Ave, Manhattan, NY") + "&output=embed",

      timeline: [
        { time: "19:00", title: "Welcome Cocktails", note: "Champagne & Jazz" },
        { time: "20:00", title: "Gala Dinner", note: "Three-course meal" },
        { time: "22:00", title: "Cake & Toast", note: "Let the party begin!" },
      ],

      enableAnalytics: false,
      analyticsEmbedHtml: ""
    };

    const THEMES = {
      vip:   { bg:"#050505", panel:"rgba(255,255,255,.05)", line:"rgba(255,255,255,.10)", accent:"#D4AF37", accent2:"#8A7036", texture: true },
      ivory: { bg:"#f6f0e7", panel:"rgba(255,255,255,.75)", line:"rgba(0,0,0,.10)",     accent:"#1a1a1a", accent2:"#6b6b6b", texture: false },
      floral:{ bg:"#fbf7f2", panel:"rgba(255,255,255,.78)", line:"rgba(0,0,0,.10)",     accent:"#B06B7A", accent2:"#7A4A56", texture: false },
      boho:  { bg:"#1a1713", panel:"rgba(255,255,255,.06)", line:"rgba(255,255,255,.10)", accent:"#C99B6C", accent2:"#8F6B49", texture: true }
    };

    /* =========================
       helpers
    ========================== */
    const $ = (id) => document.getElementById(id);
    const LS = {
      unlockSessionKey: "vipInvite_unlocked_session",
      unlockDeviceKey: "vipInvite_unlocked_device"
    };

    function setRootVar(name, val){ document.documentElement.style.setProperty(name, val); }
    function safeSetText(id, text){ const el = $(id); if(el) el.textContent = text; }
    function safeSetHTML(id, html){ const el = $(id); if(el) el.innerHTML = html; }
    function fmt2(n){ return String(n).padStart(2,'0'); }

    function buildGoogleMapsLink(query){ return "https://www.google.com/maps/search/?api=1&query=" + encodeURIComponent(query); }
    function buildAppleMapsLink(query){ return "https://maps.apple.com/?q=" + encodeURIComponent(query); }
    function buildWazeLink(query){ return "https://waze.com/ul?q=" + encodeURIComponent(query) + "&navigate=yes"; }

    // ✅ FIXED: proper HTML escaping
    function escapeHtml(s){
      return String(s ?? "").replace(/[&<>"']/g, (c)=>({
        "&": "&amp;",
        "<": "&lt;",
        ">": "&gt;",
        '"': "&quot;",
        "'": "&#39;"
      }[c]));
    }

    function escapeICSText(s){
      return String(s)
        .replace(/\\/g,"\\\\")
        .replace(/\n/g,"\\n")
        .replace(/,/g,"\\,")
        .replace(/;/g,"\\;");
    }

    function downloadICS({title, startISO, endISO, location, description}){
      const dtStamp = new Date().toISOString().replace(/[-:]/g,'').split('.')[0] + "Z";
      const start = new Date(startISO);
      const end = new Date(endISO);
      const toICS = (d) => {
        const yyyy = d.getUTCFullYear();
        const mm = fmt2(d.getUTCMonth()+1);
        const dd = fmt2(d.getUTCDate());
        const hh = fmt2(d.getUTCHours());
        const mi = fmt2(d.getUTCMinutes());
        const ss = fmt2(d.getUTCSeconds());
        return `${yyyy}${mm}${dd}T${hh}${mi}${ss}Z`;
      };
      const uid = `invite-${Math.random().toString(16).slice(2)}@invite`;
      const ics =
`BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//VIP Invite//EN
CALSCALE:GREGORIAN
METHOD:PUBLISH
BEGIN:VEVENT
UID:${uid}
DTSTAMP:${dtStamp}
DTSTART:${toICS(start)}
DTEND:${toICS(end)}
SUMMARY:${escapeICSText(title)}
LOCATION:${escapeICSText(location)}
DESCRIPTION:${escapeICSText(description || "")}
END:VEVENT
END:VCALENDAR`;

      const blob = new Blob([ics], {type:"text/calendar;charset=utf-8"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = `${title.replace(/[^\w]+/g,'_')}.ics`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(()=>URL.revokeObjectURL(a.href), 1200);
    }

    function buildGoogleCalendarLink({title, startISO, endISO, location, details}){
      const start = new Date(startISO);
      const end = new Date(endISO);
      const toGCal = (d) => {
        const yyyy = d.getUTCFullYear();
        const mm = fmt2(d.getUTCMonth()+1);
        const dd = fmt2(d.getUTCDate());
        const hh = fmt2(d.getUTCHours());
        const mi = fmt2(d.getUTCMinutes());
        const ss = fmt2(d.getUTCSeconds());
        return `${yyyy}${mm}${dd}T${hh}${mi}${ss}Z`;
      };
      const dates = `${toGCal(start)}/${toGCal(end)}`;
      const url = new URL("https://calendar.google.com/calendar/render");
      url.searchParams.set("action","TEMPLATE");
      url.searchParams.set("text", title);
      url.searchParams.set("dates", dates);
      url.searchParams.set("location", location);
      url.searchParams.set("details", details || "");
      return url.toString();
    }

    function genQR(elId, text){
      const el = $(elId);
      if(!el) return;
      el.innerHTML = "";
      if(window.QRCode){
        QRCode.toCanvas(text, { width: 120, margin: 1 }, (err, canvas) => {
          if(err){
            el.innerHTML = "<span class='text-gray-600 text-xs'>QR error</span>";
            return;
          }
          canvas.style.borderRadius = "10px";
          el.appendChild(canvas);
        });
      } else {
        el.innerHTML = "<span class='text-gray-600 text-xs'>QR unavailable</span>";
      }
    }

    function revealAll(){
      document.querySelectorAll(".reveal").forEach(el=>{
        el.classList.add("active");
        el.style.opacity = "1";
        el.style.transform = "none";
      });
    }

    /* =========================
       Theme apply
    ========================== */
    function applyTheme(themeKey){
      const t = THEMES[themeKey] || THEMES.vip;
      setRootVar("--bg", t.bg);
      setRootVar("--panel", t.panel);
      setRootVar("--line", t.line);
      setRootVar("--accent", t.accent);
      setRootVar("--accent2", t.accent2);

      const texture = document.querySelector(".texture");
      if(texture) texture.style.display = t.texture ? "block" : "none";

      if(themeKey === "ivory" || themeKey === "floral"){
        document.body.style.backgroundColor = t.bg;
        document.body.style.color = "rgba(0,0,0,.86)";
      } else {
        document.body.style.backgroundColor = t.bg;
        document.body.style.color = "rgba(255,255,255,.92)";
      }
    }
    applyTheme(CONFIG.theme);

    document.querySelectorAll(".themeBtn").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const k = btn.getAttribute("data-theme");
        applyTheme(k);
      });
    });

    /* =========================
       Apply CONFIG to UI
    ========================== */
    safeSetText("monogram", CONFIG.monogram);
    safeSetText("privateLabel", CONFIG.entranceTitle);
    safeSetText("clickLabel", CONFIG.entranceSubtitle);
    safeSetText("open-btn", CONFIG.entranceButton);

    safeSetText("pinMonogram", CONFIG.monogram);
    safeSetText("heroTop", CONFIG.heroTop);
    safeSetText("heroName", CONFIG.celebrantName);
    safeSetText("heroQuote", CONFIG.heroQuote);

    safeSetText("whenDate", CONFIG.whenDateText);
    safeSetText("whenTime", CONFIG.whenTimeText);

    safeSetText("whereName", CONFIG.venueName);
    safeSetText("whereAddress", CONFIG.venueAddress);

    safeSetText("dressCode", CONFIG.dressCode);
    safeSetText("paletteNote", CONFIG.paletteNote);
    safeSetText("registryNote", CONFIG.registryNote);
    if($("registryLink")) $("registryLink").href = CONFIG.registryUrl || "#";

    safeSetHTML("parkingInfo", CONFIG.parkingInfo);
    safeSetHTML("contactInfo", CONFIG.contactInfo);
    safeSetHTML("policyInfo", CONFIG.policyInfo);

    safeSetText("rsvpDeadline", CONFIG.rsvpDeadlineText);
    safeSetText("successText", CONFIG.successText);

    if($("rsvpForm")) $("rsvpForm").action = CONFIG.rsvpEndpoint;
    if($("guestbookForm")) $("guestbookForm").action = CONFIG.guestbookEndpoint;

    if($("uploadLink")) $("uploadLink").href = CONFIG.photoUploadUrl || "#";

    /* =========================
       Media sources
    ========================== */
    const musicEl = $("bgMusic");
    const musicBtn = $("music-btn");
    if(musicEl){
      const musicSource = musicEl.querySelector("source");
      if(musicSource) musicSource.src = CONFIG.musicSrc;
      musicEl.load();
    }

    const bgVideo = $("bgVideo");
    if(bgVideo && CONFIG.enableBgVideo && CONFIG.bgVideoSrc){
      const s = bgVideo.querySelector("source");
      if(s) s.src = CONFIG.bgVideoSrc;
      bgVideo.load();
      bgVideo.play().catch(()=>{});
      bgVideo.addEventListener("error", ()=>{ bgVideo.style.display="none"; });
    } else if(bgVideo){
      bgVideo.style.display = "none";
    }

    const momentWrap = $("momentWrap");
    const momentVideo = $("momentVideo");
    if(momentVideo && CONFIG.momentVideoSrc){
      const s = momentVideo.querySelector("source");
      if(s) s.src = CONFIG.momentVideoSrc;
      momentVideo.load();
      momentVideo.addEventListener("error", ()=>{ if(momentWrap) momentWrap.style.display="none"; });
    } else if(momentWrap){
      momentWrap.style.display = "none";
    }

    if(musicEl && musicBtn){
      musicEl.addEventListener("error", ()=>{ musicBtn.style.display = "none"; });
    }

    /* =========================
       Map + Calendar
    ========================== */
    const gLink = buildGoogleMapsLink(CONFIG.venueQuery);
    const aLink = buildAppleMapsLink(CONFIG.venueQuery);
    const wLink = buildWazeLink(CONFIG.venueQuery);

    if($("map-google")) $("map-google").href = gLink;
    if($("map-apple")) $("map-apple").href = aLink;
    if($("map-waze")) $("map-waze").href = wLink;
    if($("map-google-2")) $("map-google-2").href = gLink;
    if($("map-apple-2")) $("map-apple-2").href = aLink;
    if($("map-waze-2")) $("map-waze-2").href = wLink;

    if($("mapFrame")) $("mapFrame").src = CONFIG.mapEmbedUrl;

    const calTitle = `${CONFIG.celebrantName} · VIP Celebration`;
    const gcal = buildGoogleCalendarLink({
      title: calTitle,
      startISO: CONFIG.eventStartISO,
      endISO: CONFIG.eventEndISO,
      location: `${CONFIG.venueName} — ${CONFIG.venueAddress}`,
      details: "Invitation: " + (location.href || "")
    });

    if($("gcal-link")) $("gcal-link").href = gcal;
    if($("successGcal")) $("successGcal").href = gcal;
    if($("successDirections")) $("successDirections").href = gLink;

    const icsHandler = () => downloadICS({
      title: calTitle,
      startISO: CONFIG.eventStartISO,
      endISO: CONFIG.eventEndISO,
      location: `${CONFIG.venueName} — ${CONFIG.venueAddress}`,
      description: `Dress Code: ${CONFIG.dressCode}\n\nDirections: ${gLink}\n\nRSVP: ${location.origin + location.pathname}#rsvp`
    });

    if($("ics-btn")) $("ics-btn").addEventListener("click", icsHandler);
    if($("successIcs")) $("successIcs").addEventListener("click", icsHandler);

    /* =========================
       Timeline render
    ========================== */
    const timeline = $("timeline");
    if(timeline){
      timeline.innerHTML = "";
      CONFIG.timeline.forEach(item => {
        const block = document.createElement("div");
        block.className = "mb-12 ml-8 relative";
        block.innerHTML = `
          <div class="absolute -left-[41px] w-5 h-5 rounded-full border-4 shadow-[0_0_10px_rgba(0,0,0,.2)]"
               style="background: var(--accent); border-color: var(--bg); box-shadow: 0 0 10px color-mix(in srgb, var(--accent) 75%, transparent);"></div>
          <span class="accent-text font-bold text-sm tracking-widest">${escapeHtml(item.time)}</span>
          <h4 class="font-luxury text-xl mt-1" style="color: var(--text);">${escapeHtml(item.title)}</h4>
          <p class="text-gray-500 text-sm italic">${escapeHtml(item.note || "")}</p>
        `;
        timeline.appendChild(block);
      });
    }

    /* =========================
       Gallery render
    ========================== */
    const galleryRow = $("galleryRow");
    if(galleryRow){
      galleryRow.innerHTML = "";
      CONFIG.galleryImages.forEach(src => {
        const card = document.createElement("div");
        card.className = "flex-shrink-0 snap-center w-64 aspect-[3/4] panel p-2 border soft-line rounded-lg";
        card.innerHTML = `<img src="${src}" class="w-full h-full object-cover rounded opacity-80 hover:opacity-100 transition" alt="Memory"
                             onerror="this.closest('.flex-shrink-0').style.display='none'">`;
        galleryRow.appendChild(card);
      });
    }

    if(CONFIG.enableAnalytics && CONFIG.analyticsEmbedHtml && $("analyticsMount")){
      $("analyticsMount").innerHTML = CONFIG.analyticsEmbedHtml;
    }

    /* =========================
       PIN Gate logic
    ========================== */
    const pinScreen = $("pin-screen");
    const pinInput = $("pinInput");
    const pinSubmit = $("pinSubmit");
    const pinError = $("pinError");
    const pinBox = $("pinBox");
    const rememberDevice = $("rememberDevice");

    function showPinGate(){
      if(!pinScreen) return;
      pinScreen.classList.add("active");
      setTimeout(()=>pinInput && pinInput.focus(), 120);
    }
    function hidePinGate(){
      if(!pinScreen) return;
      pinScreen.classList.remove("active");
    }

    const unlockedSession = sessionStorage.getItem(LS.unlockSessionKey) === "1";
    const unlockedDevice  = localStorage.getItem(LS.unlockDeviceKey) === "1";

    if(!unlockedSession && !unlockedDevice){
      showPinGate();
    }

    function tryUnlock(){
      const v = (pinInput && pinInput.value || "").trim();
      if(v === CONFIG.accessPin){
        if(pinError) pinError.classList.add("hidden");
        if(pinBox){
          pinBox.classList.remove("shake");
        }
        hidePinGate();

        sessionStorage.setItem(LS.unlockSessionKey, "1");
        if(rememberDevice && rememberDevice.checked){
          localStorage.setItem(LS.unlockDeviceKey, "1");
        }
      } else {
        if(pinError) pinError.classList.remove("hidden");
        if(pinBox){
          pinBox.classList.remove("shake");
          void pinBox.offsetWidth;
          pinBox.classList.add("shake");
        }
      }
    }
    if(pinSubmit) pinSubmit.addEventListener("click", tryUnlock);
    if(pinInput) pinInput.addEventListener("keydown", (e)=>{ if(e.key==="Enter") tryUnlock(); });

    /* =========================
       Entrance + music start (blank page failsafe)
    ========================== */
    const openBtn = $("open-btn");
    const entrance = $("entrance-screen");

    let musicPlaying = false;
    function setMusicUI(on){
      if(!musicBtn) return;
      musicBtn.style.opacity = on ? "1" : "0.5";
      musicBtn.setAttribute("aria-pressed", on ? "true" : "false");
      musicBtn.title = on ? "Music: On" : "Music: Off";
    }
    setMusicUI(false);

    if(openBtn){
      openBtn.addEventListener("click", () => {
        if(entrance) entrance.classList.add("envelope-hidden");

        if(window.confetti){
          confetti({
            particleCount: 160, spread: 70, origin: { y: 0.6 },
            colors: [getComputedStyle(document.documentElement).getPropertyValue("--accent").trim() || "#D4AF37", "#ffffff"]
          });
        }

        if(musicEl){
          musicEl.play()
            .then(() => { musicPlaying = true; setMusicUI(true); })
            .catch(() => { musicPlaying = false; setMusicUI(false); });
        }

        setTimeout(()=> {
          revealAll();
          // ✅ FIX: "instant" geçersiz → "auto"
          window.scrollTo({ top: 0, left: 0, behavior: "auto" });
        }, 220);
      });
    }

    if(musicBtn){
      musicBtn.addEventListener("click", () => {
        if(!musicEl) return;
        if(musicPlaying){
          musicEl.pause();
          musicPlaying = false;
          setMusicUI(false);
        } else {
          musicEl.play()
            .then(() => { musicPlaying = true; setMusicUI(true); })
            .catch(() => { musicPlaying = false; setMusicUI(false); });
        }
      });
    }

    /* =========================
       Share buttons
    ========================== */
    async function shareLink(){
      const link = location.href;
      try{
        if(navigator.share){
          await navigator.share({ title: calTitle, text: "VIP Invite", url: link });
        } else if(navigator.clipboard){
          await navigator.clipboard.writeText(link);
          return true;
        }
      } catch {}
      return false;
    }

    if($("share-btn")){
      $("share-btn").addEventListener("click", async ()=>{
        const ok = await shareLink();
        if(ok){
          $("share-btn").innerHTML = "<i class='fa-solid fa-check mr-2'></i> Copied";
          setTimeout(()=> $("share-btn").innerHTML = "<i class='fa-solid fa-link mr-2'></i> Share Link", 1400);
        }
      });
    }
    if($("successShare")) $("successShare").addEventListener("click", shareLink);

    if($("a2hsClose")) $("a2hsClose").addEventListener("click", ()=> { if($("a2hs")) $("a2hs").style.display="none"; });

    /* =========================
       Reveal on scroll (SAFE)
    ========================== */
    (function initReveal(){
      const els = document.querySelectorAll(".reveal");
      if(!els.length) return;

      if(!("IntersectionObserver" in window)){
        revealAll();
        return;
      }

      const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if(entry.isIntersecting){
            entry.target.classList.add("active");
            observer.unobserve(entry.target);
          }
        });
      }, { threshold: 0.12 });

      els.forEach(el => observer.observe(el));

      setTimeout(()=>{
        els.forEach(el=>{
          const r = el.getBoundingClientRect();
          if(r.top < window.innerHeight * 1.05) el.classList.add("active");
        });
      }, 180);
    })();

    /* =========================
       Countdown + status
    ========================== */
    const targetDate = new Date(CONFIG.eventStartISO).getTime();
    const endDate = new Date(CONFIG.eventEndISO).getTime();

    function setStatus(text, iconClass){
      const badge = $("eventStatusBadge");
      const txt = $("eventStatusText");
      if(txt) txt.textContent = text;
      if(badge){
        const i = badge.querySelector("i");
        if(i) i.className = iconClass;
      }
    }

    function tick(){
      const now = Date.now();
      const dist = targetDate - now;

      if(now < targetDate){
        setStatus("Counting down", "fa-regular fa-clock");
      } else if(now >= targetDate && now <= endDate){
        setStatus("Tonight · Event in progress", "fa-solid fa-bolt");
      } else {
        setStatus("Thank you for coming", "fa-regular fa-heart");
      }

      if(dist <= 0){
        if($("days")) $("days").innerText = "00";
        if($("hours")) $("hours").innerText = "00";
        if($("minutes")) $("minutes").innerText = "00";
        if($("seconds")) $("seconds").innerText = "00";
        return;
      }

      const days = Math.floor(dist / (1000 * 60 * 60 * 24));
      const hours = Math.floor((dist % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
      const minutes = Math.floor((dist % (1000 * 60 * 60)) / (1000 * 60));
      const seconds = Math.floor((dist % (1000 * 60)) / 1000);

      if($("days")) $("days").innerText = String(days).padStart(2,"0");
      if($("hours")) $("hours").innerText = String(hours).padStart(2,"0");
      if($("minutes")) $("minutes").innerText = String(minutes).padStart(2,"0");
      if($("seconds")) $("seconds").innerText = String(seconds).padStart(2,"0");
    }
    tick();
    setInterval(tick, 1000);
    if($("tzHint")) $("tzHint").textContent = "Time shown in your local timezone. (" + Intl.DateTimeFormat().resolvedOptions().timeZone + ")";

    /* =========================
       QR generation
    ========================== */
    const pageLink = location.href;
    const rsvpLink = pageLink.split("#")[0] + "#rsvp";
    const mapLink = gLink;

    genQR("qr-rsvp", rsvpLink);
    genQR("qr-map", mapLink);
    genQR("qr-share", pageLink);

    /* =========================
       RSVP logic (Sheets POST)
    ========================== */
    const rsvpForm = $("rsvpForm");
    const submitBtn = $("submit-btn");
    const successMsg = $("success-msg");
    const extraFields = $("extra-fields");
    const radios = document.querySelectorAll('input[name="attendance"]');

    radios.forEach(radio => {
      radio.addEventListener('change', (e) => {
        if(extraFields) extraFields.style.display = e.target.value === 'Decline' ? 'none' : 'block';
      });
    });

    if(rsvpForm){
      rsvpForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        if(submitBtn){
          submitBtn.innerText = "SENDING...";
          submitBtn.disabled = true;
        }

        const fd = new FormData(rsvpForm);

        try {
          // POST: no-cors (Apps Script web app)
          await fetch(CONFIG.databaseURL, {
            method: 'POST',
            body: new URLSearchParams(fd),
            mode: 'no-cors'
          });

          rsvpForm.classList.add('hidden');
          if(successMsg) successMsg.classList.remove('hidden');

          if(window.confetti){
            confetti({
              particleCount: 120, spread: 60, origin: { y: 0.75 },
              colors: [getComputedStyle(document.documentElement).getPropertyValue("--accent").trim() || "#D4AF37", "#ffffff"]
            });
          }
        } catch {
          alert("Connection Error");
          if(submitBtn){
            submitBtn.innerText = "CONFIRM";
            submitBtn.disabled = false;
          }
        }
      });
    }

    /* =========================
       Admin Panel: JSONP READ (CORS-safe)
    ========================== */
    function jsonp(url){
      return new Promise((resolve, reject)=>{
        const cb = "__jsonp_cb_" + Date.now() + "_" + Math.floor(Math.random()*99999);
        const script = document.createElement("script");

        window[cb] = (data)=>{
          cleanup();
          resolve(data);
        };

        function cleanup(){
          try{ delete window[cb]; }catch{ window[cb] = undefined; }
          if(script && script.parentNode) script.parentNode.removeChild(script);
        }

        script.onerror = ()=>{
          cleanup();
          reject(new Error("JSONP load error"));
        };

        const sep = url.includes("?") ? "&" : "?";
        script.src = url + sep + "callback=" + encodeURIComponent(cb);
        document.body.appendChild(script);
      });
    }

    async function fetchAndRenderAdminData() {
      const rsvpLocalList = document.getElementById("rsvpLocalList");
      const adminStateEl = document.getElementById("adminState");

      if(rsvpLocalList){
        rsvpLocalList.innerHTML = `<div class="text-white/50 text-xs animate-pulse">Loading live data from Google Sheets...</div>`;
      }

      try {
        const data = await jsonp(CONFIG.databaseURL + "?action=read");

        const totalAttending = data.filter(r => String(r.Attendance || "") === "Attending").length;
        const totalAdults = data.reduce((acc, curr) => acc + (parseInt(curr.Adults) || 0), 0);
        const totalKids = data.reduce((acc, curr) => acc + (parseInt(curr.Kids) || 0), 0);

        if(adminStateEl){
          adminStateEl.innerHTML = `<span class="text-[10px] text-white/60">Entries: <b>${data.length}</b> | Attending: <b>${totalAttending}</b> (Adults: ${totalAdults}, Kids: ${totalKids})</span>`;
        }

        if(!rsvpLocalList) return;
        rsvpLocalList.innerHTML = "";

        if (!data.length) {
          rsvpLocalList.innerHTML = `<div class="text-white/40 text-xs">No entries found.</div>`;
          return;
        }

        data.slice().reverse().forEach(row => {
          const isAttend = String(row.Attendance || "") === "Attending";
          const colorClass = isAttend ? "text-green-400" : "text-red-400";

          const el = document.createElement("div");
          el.className = "border-b border-white/10 pb-2 mb-2 text-[11px]";
          el.innerHTML = `
            <div class="flex justify-between">
              <span class="accent-text font-bold">${escapeHtml(row.Name || "Anonymous")}</span>
              <span class="${colorClass} font-mono uppercase">${escapeHtml(row.Attendance || "-")}</span>
            </div>
            <div class="text-white/50 mt-1">
              Guests: ${escapeHtml(row.Adults ?? "")} Adults, ${escapeHtml(row.Kids ?? "")} Kids | Dietary: ${escapeHtml(row.Dietary || "-")}
            </div>
            ${row.Note ? `<div class="text-white/70 italic mt-1 bg-white/5 p-1 rounded">"${escapeHtml(row.Note)}"</div>` : ""}
            <div class="text-right text-[9px] text-white/20 mt-1">${escapeHtml(row.Date || "")}</div>
          `;
          rsvpLocalList.appendChild(el);
        });

      } catch (error) {
        if(rsvpLocalList){
          rsvpLocalList.innerHTML = `<div class="text-red-400 text-xs">Error connecting to Google Sheets.</div>`;
        }
        console.error("Admin Read Error:", error);
      }
    }

    /* =========================
       Admin modal logic
    ========================== */
    const adminModal = $("adminModal");
    const openAdmin = $("openAdmin");
    const closeAdmin = $("closeAdmin");
    const adminUnlock = $("adminUnlock");
    const adminCode = $("adminCode");
    const adminState = $("adminState");

    let adminUnlocked = false;

    if(openAdmin){
      openAdmin.addEventListener("click", ()=>{
        if(adminModal) adminModal.classList.add("open");
        setTimeout(()=>adminCode && adminCode.focus(), 150);
      });
    }
    if(closeAdmin){
      closeAdmin.addEventListener("click", ()=> { if(adminModal) adminModal.classList.remove("open"); });
    }

    if(adminUnlock){
      adminUnlock.addEventListener("click", ()=>{
        if((adminCode && adminCode.value || "").trim() === CONFIG.adminPin){
          adminUnlocked = true;
          if(adminState) adminState.textContent = "Unlocked · Loading…";
          fetchAndRenderAdminData();
        } else {
          if(adminState) adminState.textContent = "Wrong code";
        }
      });
    }

    /* =========================
       Final failsafe: Reveal
    ========================== */
    setTimeout(()=>{
      document.querySelectorAll(".reveal").forEach(el=>{
        const r = el.getBoundingClientRect();
        if(r.top < window.innerHeight * 1.1) el.classList.add("active");
      });
    }, 600);
  </script>
</body>
</html>
