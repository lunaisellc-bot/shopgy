<!DOCTYPE html>
<html lang="tr" class="scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>THE GRAND CELEBRATION | VIP Invite</title>

  <script src="https://cdn.tailwindcss.com"></script>

  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;800&family=Cormorant+Garamond:ital,wght@0,400;0,600;1,400&family=Montserrat:wght@200;400;500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            'luxury': ['Cinzel', 'serif'],
            'elegant': ['Cormorant Garamond', 'serif'],
            'modern': ['Montserrat', 'sans-serif'],
          }
        }
      }
    }
  </script>

  <style>
    :root{
      --bg: #050505;
      --panel: rgba(255,255,255,.05);
      --panel2: rgba(0,0,0,.35);
      --line: rgba(255,255,255,.10);
      --muted: rgba(255,255,255,.55);
      --text: rgba(255,255,255,.92);
      --accent: #D4AF37;
      --accent2: #8A7036;
    }

    body { background-color: var(--bg); color: var(--text); overflow-x: hidden; }

    .accent-text{ color: var(--accent); }
    .accent-dim{ color: var(--accent2); }
    .soft-line{ border-color: var(--line); }
    .accent-border{ border-color: color-mix(in srgb, var(--accent) 35%, transparent); }

    .text-gold-shine {
      background: linear-gradient(to right, #BF953F, #FCF6BA, #B38728, #FBF5B7, #AA771C);
      -webkit-background-clip: text; background-clip: text; color: transparent;
      background-size: 200% auto; animation: shine 6s linear infinite;
    }
    @keyframes shine { to { background-position: 200% center; } }

    .hide-scrollbar::-webkit-scrollbar { display: none; }
    .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

    /* Entrance (PIN geÃ§ilmeden gÃ¶rÃ¼nmez) */
    #entrance-screen {
      position: fixed; inset: 0; z-index: 110; background: #000;
      display: none;
      align-items: center; justify-content: center;
      transition: transform 1.2s cubic-bezier(0.77, 0, 0.175, 1);
    }
    #entrance-screen.show{ display:flex; }
    .envelope-hidden { transform: translateY(-100%); }

    /* âœ… PIN Gate: default gÃ¶rÃ¼nÃ¼r (JS Ã§alÄ±ÅŸmazsa bile boÅŸ sayfa olmaz) */
    #pin-screen{
      position: fixed; inset: 0; z-index: 120;
      display: flex;
      align-items: center;
      justify-content: center;
      background: radial-gradient(900px 420px at 50% 10%, rgba(212,175,55,.12), rgba(0,0,0,1));
    }
    #pin-screen.hidden{ display:none; }

    /* Reveal (scroll anim) */
    .reveal { opacity: 0; transform: translateY(30px); transition: all 1s ease-out; }
    .reveal.active { opacity: 1; transform: translateY(0); }

    /* texture */
    .texture {
      position: fixed; inset:0; pointer-events:none; opacity:.18;
      background-image: url('https://www.transparenttextures.com/patterns/stardust.png');
      display:block;
    }

    /* shake wrong pin */
    @keyframes shake {
      0%,100%{ transform: translateX(0); }
      20%{ transform: translateX(-6px); }
      40%{ transform: translateX(6px); }
      60%{ transform: translateX(-4px); }
      80%{ transform: translateX(4px); }
    }
    .shake{ animation: shake .35s ease-in-out; }

    /* Admin modal */
    #adminModal{
      position: fixed; inset:0; z-index: 200;
      display:none; align-items:center; justify-content:center;
      background: rgba(0,0,0,.72);
      padding: 18px;
    }
    #adminModal.open{ display:flex; }

    /* badges */
    .badge{
      display:inline-flex; align-items:center; gap:8px;
      padding:10px 14px; border-radius:999px;
      border: 1px solid var(--line);
      background: rgba(0,0,0,.35);
      backdrop-filter: blur(10px);
      color: rgba(255,255,255,.80);
      font-size: 11px;
      letter-spacing: .12em;
      text-transform: uppercase;
    }
  </style>
</head>

<body class="font-modern">

  <!-- =======================
      PIN SCREEN (VIP ACCESS)
  ======================== -->
  <div id="pin-screen" aria-modal="true" role="dialog">
    <div class="w-full max-w-md mx-auto px-6">
      <div class="border soft-line rounded-2xl p-8 shadow-[0_30px_80px_rgba(0,0,0,.55)]"
           style="background: rgba(0,0,0,.72); backdrop-filter: blur(14px);">
        <div class="text-center">
          <div class="w-20 h-20 mx-auto mb-5 rounded-full border soft-line flex items-center justify-center relative">
            <div class="absolute inset-0 rounded-full" style="background: rgba(212,175,55,.10);"></div>
            <span class="font-luxury text-4xl accent-text" id="pinMonogram">S</span>
          </div>

          <h2 class="font-luxury text-white text-xl tracking-[0.35em] mb-2">VIP ACCESS</h2>
          <p class="text-xs" style="color: var(--muted); letter-spacing:.14em; text-transform:uppercase;">
            Enter your private code
          </p>
        </div>

        <div class="mt-8" id="pinBox">
          <label class="text-xs uppercase tracking-widest" style="color: var(--muted);">Access Code</label>
          <input id="pinInput" inputmode="numeric" maxlength="10"
                 class="mt-2 w-full bg-black/30 border-b border-white/20 py-3 text-white focus:outline-none focus:border-[color:var(--accent)] transition placeholder-gray-600"
                 placeholder="â€¢â€¢â€¢â€¢" />

          <div class="mt-3 flex items-center justify-between gap-3">
            <label class="text-xs" style="color: var(--muted);">
              <input type="checkbox" id="rememberDevice" class="mr-2 align-middle" />
              Remember this device
            </label>
            <button id="pinSubmit"
              class="px-5 py-2 rounded-full border soft-line text-xs hover:border-[color:var(--accent)] transition"
              style="background: rgba(0,0,0,.35);">
              Unlock
            </button>
          </div>

          <p id="pinError" class="text-xs mt-3 hidden" style="color: rgba(255,255,255,.78);">
            Incorrect code. Please try again.
          </p>
        </div>

        <div class="mt-8 border-t soft-line pt-5">
          <p class="text-[11px]" style="color: var(--muted); line-height:1.6;">
            Delivered as a private shareable link. No downloads required.
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- =======================
       ENTRANCE SCREEN
  ======================== -->
  <div id="entrance-screen">
    <div class="text-center relative px-6">
      <div class="w-24 h-24 mx-auto mb-8 rounded-full border-2 soft-line flex items-center justify-center relative">
        <div class="absolute inset-0 rounded-full" style="background: rgba(212,175,55,.10);"></div>
        <span class="font-luxury text-4xl accent-text" id="monogram">S</span>
      </div>

      <h2 class="font-luxury text-white text-xl tracking-[0.4em] mb-2" id="privateLabel">PRIVATE EVENT</h2>
      <p class="text-gray-500 text-xs mb-10 tracking-widest uppercase" id="clickLabel">Click to Reveal Invitation</p>

      <button id="open-btn"
        class="group relative px-8 py-4 bg-transparent border accent-border text-[color:var(--accent)] font-luxury tracking-widest hover:bg-[color:var(--accent)] hover:text-black transition duration-500">
        OPEN ENVELOPE
      </button>
    </div>
  </div>

  <div class="texture"></div>

  <!-- =======================
       MAIN CONTENT
  ======================== -->
  <div id="main-content" class="relative min-h-screen">

    <audio id="bgMusic" loop preload="metadata">
      <source id="musicSource" src="assets/music.mp3" type="audio/mpeg">
    </audio>

    <button id="music-btn"
      class="fixed bottom-6 right-6 z-50 w-12 h-12 border accent-border rounded-full accent-text flex items-center justify-center shadow-[0_0_15px_rgba(212,175,55,0.25)] hover:scale-110 transition"
      style="background: rgba(0,0,0,.35); backdrop-filter: blur(10px);"
      aria-label="Music" aria-pressed="false" title="Music">
      <i class="fa-solid fa-music"></i>
    </button>

    <button id="share-btn"
      class="fixed bottom-6 left-6 z-50 hidden md:inline-flex items-center gap-2 px-4 py-3 border soft-line rounded-full text-xs text-white/80 hover:text-white hover:border-[color:var(--accent)] transition"
      style="background: rgba(0,0,0,.35); backdrop-filter: blur(10px);">
      <i class="fa-solid fa-link"></i> Share Link
    </button>

    <div id="a2hs"
      class="fixed top-4 left-1/2 -translate-x-1/2 z-50 hidden md:block px-4 py-3 border soft-line rounded-full text-[11px] text-white/70"
      style="background: rgba(0,0,0,.35); backdrop-filter: blur(10px);">
      Tip: On iPhone, tap <span class="accent-text font-semibold">Share</span> â†’ <span class="accent-text font-semibold">Add to Home Screen</span>
      <button id="a2hsClose" class="ml-3 opacity-70 hover:opacity-100"><i class="fa-solid fa-xmark"></i></button>
    </div>

    <!-- HERO -->
    <header class="relative pt-24 pb-16 text-center px-4 overflow-hidden">

      <div class="max-w-3xl mx-auto mb-8 reveal">
        <span class="badge"><i class="fa-solid fa-globe"></i> NOT A PDF Â· A REAL WEBSITE</span>
      </div>

      <p class="tracking-[0.3em] text-xs uppercase mb-6 reveal" style="color: rgba(212,175,55,.8);" id="heroTop">
        Join us for the 30th Birthday of
      </p>

      <h1 class="font-luxury text-6xl md:text-8xl text-gold-shine mb-6 drop-shadow-2xl reveal" id="heroName">
        SOPHIA
      </h1>

      <div class="h-px w-32 mx-auto mb-6 reveal" style="background: linear-gradient(to right, transparent, var(--accent), transparent);"></div>

      <p class="font-elegant text-2xl text-white/80 italic reveal" id="heroQuote">
        "A Night of Elegance & Memories"
      </p>

      <div class="mt-7 reveal">
        <span class="badge"><i class="fa-solid fa-link"></i> Delivered as a private shareable link</span>
      </div>

      <!-- QR -->
      <div class="max-w-4xl mx-auto mt-10 px-6 reveal">
        <div class="grid md:grid-cols-3 gap-4">
          <div class="border soft-line rounded-xl p-4 text-center" style="background: rgba(255,255,255,.04);">
            <div class="text-xs tracking-widest uppercase text-gray-400 mb-2">QR Â· RSVP</div>
            <div class="mx-auto w-[120px] h-[120px] rounded-lg border soft-line flex items-center justify-center" style="background: rgba(0,0,0,.35);" id="qr-rsvp">
              <span class="text-gray-600 text-xs">Loadingâ€¦</span>
            </div>
          </div>

          <div class="border soft-line rounded-xl p-4 text-center" style="background: rgba(255,255,255,.04);">
            <div class="text-xs tracking-widest uppercase text-gray-400 mb-2">QR Â· Map</div>
            <div class="mx-auto w-[120px] h-[120px] rounded-lg border soft-line flex items-center justify-center" style="background: rgba(0,0,0,.35);" id="qr-map">
              <span class="text-gray-600 text-xs">Loadingâ€¦</span>
            </div>
          </div>

          <div class="border soft-line rounded-xl p-4 text-center" style="background: rgba(255,255,255,.04);">
            <div class="text-xs tracking-widest uppercase text-gray-400 mb-2">QR Â· Share</div>
            <div class="mx-auto w-[120px] h-[120px] rounded-lg border soft-line flex items-center justify-center" style="background: rgba(0,0,0,.35);" id="qr-share">
              <span class="text-gray-600 text-xs">Loadingâ€¦</span>
            </div>
          </div>
        </div>
        <p class="text-gray-500 text-[11px] mt-4">
          QR codes are generated from this pageâ€™s links. In final delivery, they will point to the private shareable link.
        </p>
      </div>
    </header>

    <!-- COUNTDOWN -->
    <section class="max-w-4xl mx-auto px-6 mb-16">
      <div class="grid grid-cols-4 gap-4 text-center border-y soft-line py-8 reveal">
        <div><span class="block font-luxury text-3xl md:text-5xl accent-text" id="days">00</span><span class="text-xs text-gray-500 uppercase tracking-widest">Days</span></div>
        <div><span class="block font-luxury text-3xl md:text-5xl accent-text" id="hours">00</span><span class="text-xs text-gray-500 uppercase tracking-widest">Hrs</span></div>
        <div><span class="block font-luxury text-3xl md:text-5xl accent-text" id="minutes">00</span><span class="text-xs text-gray-500 uppercase tracking-widest">Mins</span></div>
        <div><span class="block font-luxury text-3xl md:text-5xl accent-text" id="seconds">00</span><span class="text-xs text-gray-500 uppercase tracking-widest">Secs</span></div>
      </div>

      <p class="text-center text-gray-600 text-xs mt-4" id="tzHint">Time shown in your local timezone.</p>

      <div class="flex flex-wrap justify-center gap-3 mt-6 reveal">
        <button id="ics-btn" class="px-6 py-3 border accent-border rounded-full text-xs text-white/80 hover:text-white hover:border-[color:var(--accent)] transition">
          <i class="fa-regular fa-calendar mr-2"></i> Download Calendar (.ics)
        </button>
        <a id="gcal-link" target="_blank" rel="noopener"
           class="px-6 py-3 border accent-border rounded-full text-xs text-white/80 hover:text-white hover:border-[color:var(--accent)] transition"
           href="#">
          <i class="fa-brands fa-google mr-2"></i> Add to Google Calendar
        </a>
      </div>
    </section>

    <!-- MAP -->
    <section class="max-w-4xl mx-auto px-6 mb-16 reveal" id="map">
      <div class="border soft-line rounded-xl overflow-hidden" style="background: rgba(255,255,255,.04);">
        <div class="p-6 border-b soft-line flex items-center justify-between gap-3 flex-wrap">
          <div>
            <h2 class="font-luxury text-2xl text-white">Map</h2>
            <p class="text-gray-500 text-xs mt-1" id="mapSub">Tap for directions.</p>
          </div>
          <div class="flex gap-2 flex-wrap">
            <a id="map-google" target="_blank" rel="noopener"
               class="px-5 py-2 border soft-line rounded-full text-[11px] text-white/70 hover:text-white hover:border-[color:var(--accent)] transition"
               href="#">Google</a>
            <a id="map-apple" target="_blank" rel="noopener"
               class="px-5 py-2 border soft-line rounded-full text-[11px] text-white/70 hover:text-white hover:border-[color:var(--accent)] transition"
               href="#">Apple</a>
            <a id="map-waze" target="_blank" rel="noopener"
               class="px-5 py-2 border soft-line rounded-full text-[11px] text-white/70 hover:text-white hover:border-[color:var(--accent)] transition"
               href="#">Waze</a>
          </div>
        </div>

        <div id="mapFallback" class="hidden p-6 text-sm text-white/70">
          Map could not be loaded on this device. Please use the direction buttons above.
        </div>

        <iframe id="mapFrame" class="w-full h-[420px]" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>
      </div>
    </section>

    <!-- RSVP -->
    <section id="rsvp" class="max-w-xl mx-auto px-6 pb-24 reveal">
      <div class="relative border accent-border p-8 md:p-12 rounded-t-[3rem] shadow-[0_-10px_40px_rgba(0,0,0,0.45)]"
           style="background: rgba(255,255,255,.04);">
        <div class="absolute -top-3 left-1/2 transform -translate-x-1/2 w-32 h-6 rounded-b-full border-b accent-border" style="background: var(--bg);"></div>

        <div class="text-center mb-8">
          <h2 class="font-luxury text-4xl text-white mb-2">R.S.V.P</h2>
          <p class="accent-dim text-sm uppercase tracking-widest" id="rsvpDeadline">By October 10th</p>
        </div>

        <div id="rsvpDisabled" class="hidden text-center p-6 border soft-line rounded-2xl" style="background: rgba(0,0,0,.35);">
          <p class="text-sm text-white/80">RSVP is not configured yet.</p>
          <p class="text-[11px] mt-2 text-white/60">Host can enable it by adding the RSVP endpoint.</p>
        </div>

        <div id="success-msg" class="hidden text-center py-10">
          <i class="fa-regular fa-circle-check text-5xl accent-text mb-4"></i>
          <h3 class="text-white font-luxury text-xl">Confirmed!</h3>
          <p class="text-gray-500 mt-2" id="successText">See you on the dance floor.</p>
        </div>

        <form id="rsvpForm" action="" method="POST" class="space-y-5">
          <div>
            <input type="text" name="name" required placeholder="Guest Name(s)"
              class="w-full bg-black/30 border-b border-white/20 py-3 text-white focus:outline-none focus:border-[color:var(--accent)] transition placeholder-gray-600">
          </div>

          <div class="flex gap-4">
            <label class="flex-1 cursor-pointer">
              <input type="radio" name="attendance" value="Attending" class="peer hidden" checked>
              <div class="py-3 text-center border soft-line rounded text-gray-400 peer-checked:bg-[color:var(--accent)] peer-checked:text-black peer-checked:font-bold transition">Accept</div>
            </label>
            <label class="flex-1 cursor-pointer">
              <input type="radio" name="attendance" value="Decline" class="peer hidden">
              <div class="py-3 text-center border soft-line rounded text-gray-400 peer-checked:bg-red-900/40 peer-checked:text-white peer-checked:border-red-800 transition">Decline</div>
            </label>
          </div>

          <div id="extra-fields" class="space-y-5">
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="text-xs uppercase tracking-widest" style="color: var(--muted);">Adults</label>
                <select name="adults" class="mt-2 w-full bg-black/30 border-b border-white/20 py-3 text-white focus:outline-none focus:border-[color:var(--accent)] transition">
                  <option value="1" class="bg-black">1</option><option value="2" class="bg-black">2</option><option value="3" class="bg-black">3</option><option value="4" class="bg-black">4</option>
                </select>
              </div>
              <div>
                <label class="text-xs uppercase tracking-widest" style="color: var(--muted);">Kids</label>
                <select name="kids" class="mt-2 w-full bg-black/30 border-b border-white/20 py-3 text-white focus:outline-none focus:border-[color:var(--accent)] transition">
                  <option value="0" class="bg-black">0</option><option value="1" class="bg-black">1</option><option value="2" class="bg-black">2</option><option value="3" class="bg-black">3</option>
                </select>
              </div>
            </div>

            <div>
              <label class="text-xs uppercase tracking-widest" style="color: var(--muted);">Dietary</label>
              <select name="dietary" class="mt-2 w-full bg-black/30 border-b border-white/20 py-3 text-white focus:outline-none focus:border-[color:var(--accent)] transition">
                <option value="No preference" class="bg-black">No preference</option>
                <option value="Vegetarian" class="bg-black">Vegetarian</option>
                <option value="Vegan" class="bg-black">Vegan</option>
                <option value="Gluten-free" class="bg-black">Gluten-free</option>
                <option value="Halal" class="bg-black">Halal</option>
              </select>
            </div>

            <div>
              <input type="text" name="allergies" placeholder="Allergies (optional)"
                class="w-full bg-black/30 border-b border-white/20 py-3 text-white focus:outline-none focus:border-[color:var(--accent)] transition placeholder-gray-600 text-sm">
            </div>

            <div>
              <input type="text" name="song_request" placeholder="ðŸŽµ Song Request for DJ (optional)"
                class="w-full bg-black/30 border-b border-white/20 py-3 text-white focus:outline-none focus:border-[color:var(--accent)] transition placeholder-gray-600 text-sm">
            </div>

            <div>
              <textarea name="note" placeholder="Message to the host (optional)"
                class="w-full bg-black/30 border border-white/10 rounded-xl p-4 text-white focus:outline-none focus:border-[color:var(--accent)] transition placeholder-gray-600 text-sm"
                rows="3"></textarea>
            </div>
          </div>

          <button type="submit" id="submit-btn"
            class="w-full bg-[color:var(--accent)] hover:bg-white hover:text-black text-black font-luxury font-bold py-4 rounded shadow-[0_0_20px_rgba(212,175,55,0.35)] transition duration-500 mt-2">
            CONFIRM
          </button>

          <p class="text-gray-600 text-[11px] leading-relaxed">
            One-time purchase Â· No subscription Â· Not a PDF Â· Delivered as a private shareable link
          </p>
        </form>
      </div>
    </section>

    <div id="analyticsMount"></div>
  </div>

  <script>
    /* =========================
       CONFIG (EDIT ONLY THIS)
    ========================== */
    const CONFIG = {
      accessPin: "2580",
      adminPin: "9999",

      monogram: "S",

      entranceTitle: "PRIVATE EVENT",
      entranceSubtitle: "Click to Reveal Invitation",
      entranceButton: "OPEN ENVELOPE",

      heroTop: "Join us for the 30th Birthday of",
      celebrantName: "SOPHIA",
      heroQuote: "\"A Night of Elegance & Memories\"",

      eventStartISO: "2026-10-25T19:00:00-04:00",
      eventEndISO:   "2026-10-26T01:00:00-04:00",

      venueQuery: "The Grand Ballroom, 123 Luxury Ave, Manhattan, NY",
      mapEmbedUrl: "https://www.google.com/maps?q=" + encodeURIComponent("The Grand Ballroom, 123 Luxury Ave, Manhattan, NY") + "&output=embed",

      rsvpDeadlineText: "By October 10th",
      rsvpEndpoint: "https://formspree.io/f/XXXXXXXX",  // <- gerÃ§ek endpoint
      enableAnalytics: false,
      analyticsEmbedHtml: ""
    };

    const $ = (id) => document.getElementById(id);
    function safeSetText(id, text){ const el = $(id); if(el) el.textContent = text; }
    function fmt2(n){ return String(n).padStart(2,'0'); }

    // bind texts
    safeSetText("pinMonogram", CONFIG.monogram);
    safeSetText("monogram", CONFIG.monogram);
    safeSetText("privateLabel", CONFIG.entranceTitle);
    safeSetText("clickLabel", CONFIG.entranceSubtitle);
    safeSetText("open-btn", CONFIG.entranceButton);
    safeSetText("heroTop", CONFIG.heroTop);
    safeSetText("heroName", CONFIG.celebrantName);
    safeSetText("heroQuote", CONFIG.heroQuote);
    safeSetText("rsvpDeadline", CONFIG.rsvpDeadlineText);

    /* ===========
       PIN FLOW (device/session)
    =========== */
    const pinScreen = $("pin-screen");
    const entrance = $("entrance-screen");
    const pinInput = $("pinInput");
    const pinSubmit = $("pinSubmit");
    const pinError = $("pinError");
    const pinBox = $("pinBox");
    const rememberDevice = $("rememberDevice");

    const unlockKey = "vipInvite_unlocked";
    const unlockedSession = sessionStorage.getItem(unlockKey) === "1";
    const unlockedDevice  = localStorage.getItem(unlockKey) === "1";

    function showEntrance(){
      entrance.classList.add("show");
    }
    function showPinGate(){
      pinScreen.classList.remove("hidden");
      entrance.classList.remove("show");
      setTimeout(()=>pinInput.focus(), 120);
    }
    function hidePinGate(){
      pinScreen.classList.add("hidden");
    }

    if(unlockedSession || unlockedDevice){
      hidePinGate();
      showEntrance();
    } else {
      showPinGate();
    }

    function tryUnlock(){
      const v = (pinInput.value || "").trim();
      if(v === CONFIG.accessPin){
        pinError.classList.add("hidden");
        pinBox.classList.remove("shake");
        hidePinGate();
        showEntrance();

        if(rememberDevice.checked){
          localStorage.setItem(unlockKey, "1");
        } else {
          sessionStorage.setItem(unlockKey, "1");
        }
      } else {
        pinError.classList.remove("hidden");
        pinBox.classList.remove("shake");
        void pinBox.offsetWidth;
        pinBox.classList.add("shake");
      }
    }

    pinSubmit.addEventListener("click", tryUnlock);
    pinInput.addEventListener("keydown", (e)=>{ if(e.key==="Enter") tryUnlock(); });

    /* ===========
       Entrance open + music
    =========== */
    const openBtn = $("open-btn");
    const musicBtn = $("music-btn");
    const musicEl = $("bgMusic");
    const musicSource = $("musicSource");
    let musicPlaying = false;

    function setMusicUI(on){
      musicBtn.style.opacity = on ? "1" : "0.5";
      musicBtn.setAttribute("aria-pressed", on ? "true" : "false");
    }
    setMusicUI(false);

    openBtn.addEventListener("click", () => {
      entrance.classList.add("envelope-hidden");

      confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 }, colors: ['#D4AF37', '#ffffff'] });

      musicEl.play()
        .then(() => { musicPlaying = true; setMusicUI(true); })
        .catch(() => { musicPlaying = false; setMusicUI(false); });

      /* âœ… CRITICAL FIX: reveal everything after open (no more blank page) */
      setTimeout(() => {
        document.querySelectorAll('.reveal').forEach(el => {
          el.classList.add('active');
          el.style.opacity = '1';
          el.style.transform = 'none';
        });
        window.scrollTo({ top: 0, behavior: 'instant' });
      }, 300);
    });

    musicBtn.addEventListener("click", () => {
      if(musicPlaying){
        musicEl.pause(); musicPlaying = false; setMusicUI(false);
      } else {
        musicEl.play().then(()=>{ musicPlaying=true; setMusicUI(true); }).catch(()=>{ musicPlaying=false; setMusicUI(false); });
      }
    });

    musicSource.addEventListener("error", ()=>{ musicBtn.style.display="none"; });

    /* ===========
       Reveal observer (nice-to-have)
    =========== */
    (function initReveal(){
      const els = document.querySelectorAll('.reveal');
      if(!els.length) return;

      if(!('IntersectionObserver' in window)){
        els.forEach(el => el.classList.add('active'));
        return;
      }

      const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if(entry.isIntersecting){
            entry.target.classList.add('active');
            observer.unobserve(entry.target);
          }
        });
      }, { threshold: 0.12 });

      els.forEach(el => observer.observe(el));

      setTimeout(() => {
        els.forEach(el => {
          const r = el.getBoundingClientRect();
          if(r.top < window.innerHeight * 1.05) el.classList.add('active');
        });
      }, 150);
    })();

    /* ===========
       Share
    =========== */
    async function shareLink(){
      const link = location.href;
      try{
        if(navigator.share){
          await navigator.share({ title: document.title, text: "VIP Invite", url: link });
        } else {
          await navigator.clipboard.writeText(link);
          return true;
        }
      } catch {}
      return false;
    }

    $("share-btn").addEventListener("click", async ()=>{
      const ok = await shareLink();
      if(ok){
        $("share-btn").innerHTML = "<i class='fa-solid fa-check'></i> Copied";
        setTimeout(()=> $("share-btn").innerHTML = "<i class='fa-solid fa-link'></i> Share Link", 1400);
      }
    });

    $("a2hsClose").addEventListener("click", ()=> $("a2hs").style.display="none");

    /* ===========
       QR
    =========== */
    function genQR(elId, text){
      const el = $(elId);
      if(!el) return;
      el.innerHTML = "";
      if(window.QRCode){
        QRCode.toCanvas(text, { width: 120, margin: 1 }, (err, canvas) => {
          if(err){ el.innerHTML = "<span class='text-gray-600 text-xs'>QR error</span>"; return; }
          canvas.style.borderRadius = "10px";
          el.appendChild(canvas);
        });
      } else {
        el.innerHTML = "<span class='text-gray-600 text-xs'>QR unavailable</span>";
      }
    }

    const pageLink = location.href;
    genQR("qr-rsvp", pageLink.split("#")[0] + "#rsvp");
    genQR("qr-map", pageLink.split("#")[0] + "#map");
    genQR("qr-share", pageLink);

    /* ===========
       Countdown
    =========== */
    const targetDate = new Date(CONFIG.eventStartISO).getTime();

    function tick(){
      const now = Date.now();
      const dist = targetDate - now;
      if(dist <= 0){
        $("days").innerText="00"; $("hours").innerText="00"; $("minutes").innerText="00"; $("seconds").innerText="00";
        return;
      }
      const days = Math.floor(dist / (1000 * 60 * 60 * 24));
      const hours = Math.floor((dist % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
      const minutes = Math.floor((dist % (1000 * 60 * 60)) / (1000 * 60));
      const seconds = Math.floor((dist % (1000 * 60)) / 1000);

      $("days").innerText = fmt2(days);
      $("hours").innerText = fmt2(hours);
      $("minutes").innerText = fmt2(minutes);
      $("seconds").innerText = fmt2(seconds);
    }
    tick();
    setInterval(tick, 1000);
    $("tzHint").textContent = "Time shown in your local timezone. (" + Intl.DateTimeFormat().resolvedOptions().timeZone + ")";

    /* ===========
       Calendar buttons
    =========== */
    function escapeICSText(s){
      return String(s).replace(/\\/g,"\\\\").replace(/\n/g,"\\n").replace(/,/g,"\\,").replace(/;/g,"\\;");
    }
    function downloadICS(){
      const title = `${CONFIG.celebrantName} Â· VIP Celebration`;
      const start = new Date(CONFIG.eventStartISO);
      const end = new Date(CONFIG.eventEndISO);
      const toICS = (d) => {
        const yyyy = d.getUTCFullYear();
        const mm = fmt2(d.getUTCMonth()+1);
        const dd = fmt2(d.getUTCDate());
        const hh = fmt2(d.getUTCHours());
        const mi = fmt2(d.getUTCMinutes());
        const ss = fmt2(d.getUTCSeconds());
        return `${yyyy}${mm}${dd}T${hh}${mi}${ss}Z`;
      };
      const uid = `invite-${Math.random().toString(16).slice(2)}@invite`;
      const ics =
`BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//VIP Invite//EN
CALSCALE:GREGORIAN
METHOD:PUBLISH
BEGIN:VEVENT
UID:${uid}
DTSTART:${toICS(start)}
DTEND:${toICS(end)}
SUMMARY:${escapeICSText(title)}
LOCATION:${escapeICSText(CONFIG.venueQuery)}
END:VEVENT
END:VCALENDAR`;
      const blob = new Blob([ics], {type:"text/calendar;charset=utf-8"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "event.ics";
      document.body.appendChild(a); a.click(); a.remove();
      setTimeout(()=>URL.revokeObjectURL(a.href), 1200);
    }

    function buildGoogleCalendarLink(){
      const title = `${CONFIG.celebrantName} Â· VIP Celebration`;
      const start = new Date(CONFIG.eventStartISO);
      const end = new Date(CONFIG.eventEndISO);
      const toGCal = (d) => {
        const yyyy = d.getUTCFullYear();
        const mm = fmt2(d.getUTCMonth()+1);
        const dd = fmt2(d.getUTCDate());
        const hh = fmt2(d.getUTCHours());
        const mi = fmt2(d.getUTCMinutes());
        const ss = fmt2(d.getUTCSeconds());
        return `${yyyy}${mm}${dd}T${hh}${mi}${ss}Z`;
      };
      const dates = `${toGCal(start)}/${toGCal(end)}`;
      const url = new URL("https://calendar.google.com/calendar/render");
      url.searchParams.set("action","TEMPLATE");
      url.searchParams.set("text", title);
      url.searchParams.set("dates", dates);
      url.searchParams.set("location", CONFIG.venueQuery);
      return url.toString();
    }

    $("ics-btn").addEventListener("click", downloadICS);
    $("gcal-link").href = buildGoogleCalendarLink();

    /* ===========
       Map + fallback
    =========== */
    function buildGoogleMapsLink(q){ return "https://www.google.com/maps/search/?api=1&query=" + encodeURIComponent(q); }
    function buildAppleMapsLink(q){ return "https://maps.apple.com/?q=" + encodeURIComponent(q); }
    function buildWazeLink(q){ return "https://waze.com/ul?q=" + encodeURIComponent(q) + "&navigate=yes"; }

    $("map-google").href = buildGoogleMapsLink(CONFIG.venueQuery);
    $("map-apple").href = buildAppleMapsLink(CONFIG.venueQuery);
    $("map-waze").href = buildWazeLink(CONFIG.venueQuery);

    const mapFrame = $("mapFrame");
    mapFrame.src = CONFIG.mapEmbedUrl;

    let mapLoaded = false;
    mapFrame.addEventListener("load", ()=>{ mapLoaded = true; });
    setTimeout(()=>{
      if(!mapLoaded){
        $("mapFallback").classList.remove("hidden");
        mapFrame.style.display = "none";
      }
    }, 3000);

    /* ===========
       RSVP endpoint guard
    =========== */
    const rsvpForm = $("rsvpForm");
    const rsvpDisabled = $("rsvpDisabled");
    const submitBtn = $("submit-btn");
    const successMsg = $("success-msg");
    const extraFields = $("extra-fields");
    const radios = document.querySelectorAll('input[name="attendance"]');

    function endpointLooksValid(url){
      return typeof url === "string" && url.startsWith("https://") && !url.includes("XXXXXXXX");
    }

    if(endpointLooksValid(CONFIG.rsvpEndpoint)){
      rsvpForm.action = CONFIG.rsvpEndpoint;
      rsvpDisabled.classList.add("hidden");
      rsvpForm.classList.remove("hidden");
    } else {
      rsvpForm.classList.add("hidden");
      rsvpDisabled.classList.remove("hidden");
    }

    radios.forEach(radio => {
      radio.addEventListener('change', (e) => {
        extraFields.style.display = e.target.value === 'Decline' ? 'none' : 'block';
      });
    });

    rsvpForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      submitBtn.innerText = "SENDING...";
      submitBtn.disabled = true;

      try {
        const res = await fetch(rsvpForm.action, {
          method: 'POST',
          body: new FormData(rsvpForm),
          headers: { 'Accept': 'application/json' }
        });

        if(res.ok) {
          rsvpForm.classList.add('hidden');
          successMsg.classList.remove('hidden');
          confetti({ particleCount: 100, spread: 60, origin: { y: 0.75 }, colors: ['#D4AF37', '#ffffff'] });

          // local reveal safety
          document.querySelectorAll('.reveal').forEach(el => {
            el.classList.add('active');
            el.style.opacity = '1';
            el.style.transform = 'none';
          });
        } else {
          alert("Error. Try again.");
          submitBtn.innerText = "CONFIRM";
          submitBtn.disabled = false;
        }
      } catch {
        alert("Connection Error");
        submitBtn.innerText = "CONFIRM";
        submitBtn.disabled = false;
      }
    });

    /* ===========
       Analytics
    =========== */
    if(CONFIG.enableAnalytics && CONFIG.analyticsEmbedHtml){
      $("analyticsMount").innerHTML = CONFIG.analyticsEmbedHtml;
    }
  </script>
</body>
</html>
